"use strict";(()=>{var w=document.getElementById("jsonFileInput"),B=document.getElementById("validIcon"),A=document.getElementById("loadJsonBtn"),S=document.getElementById("metadataDisplay"),D=document.getElementById("algoLabel"),N=document.getElementById("secLevelLabel"),P=document.getElementById("openCreateModalBtn"),v=document.getElementById("createStorageModal"),k=document.getElementById("closeCreateModalBtn"),M=document.getElementById("createMasterPasswordInput"),U=document.getElementById("algorithmSelect"),J=document.getElementById("securityLevelSelect"),O=document.getElementById("createStorageBtn"),E=document.getElementById("entriesContainer"),F=document.getElementById("openAddEntryBtn"),L=document.getElementById("addEntryModal"),j=document.getElementById("closeAddEntryModalBtn"),h=document.getElementById("websiteInput"),I=document.getElementById("usernameInput"),b=document.getElementById("passwordInput"),C=document.getElementById("noteInput"),K=document.getElementById("submitNewEntryBtn"),x=document.getElementById("detailModal"),G=document.getElementById("closeDetailModalBtn"),R=document.getElementById("detailWebsite"),V=document.getElementById("detailUsername"),W=document.getElementById("detailPassword"),q=document.getElementById("detailNotes"),z=document.getElementById("saveJsonBtn"),y="",l=null,d=null,o={metadata:{algorithm:"AES-GCM",securityLevel:"256-bit"},entries:[]};function m(t){let e=window.atob(t),n=e.length,a=new Uint8Array(n);for(let s=0;s<n;s++)a[s]=e.charCodeAt(s);return a.buffer}function g(t){let e=new Uint8Array(t),n="";for(let a=0;a<e.byteLength;a++)n+=String.fromCharCode(e[a]);return window.btoa(n)}async function T(t,e){let n=new TextEncoder,a=await window.crypto.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:1e5,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function Q(t,e){l||(l=window.crypto.getRandomValues(new Uint8Array(16))),d||(d=window.crypto.getRandomValues(new Uint8Array(12)));let n=await T(t,l),a=new TextEncoder,s=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:d},n,a.encode(e));return{iv:g(d.buffer),salt:g(l.buffer),data:g(s)}}async function X(t,e){let n=new Uint8Array(m(e.iv)),a=new Uint8Array(m(e.salt)),s=m(e.data),i=await T(t,a),c=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},i,s);return new TextDecoder().decode(c)}async function Y(){if(y){let t=JSON.stringify(o),e=await Q(y,t);return JSON.stringify(e,null,2)}else return JSON.stringify({iv:"",salt:"",data:JSON.stringify(o)},null,2)}async function Z(t,e){let n=JSON.parse(t);if(!n.iv&&!n.salt)return JSON.parse(n.data);let a=await X(e,n);return JSON.parse(a)}function f(){E.innerHTML="";let t=o.entries;if(!t||t.length===0){let e=document.createElement("div");e.className="text-gray-500 text-center p-4",e.textContent="No entries yet",E.appendChild(e);return}t.forEach(e=>{let n=document.createElement("div");n.className="p-3 border rounded flex items-center justify-between hover:bg-gray-50";let a=document.createElement("div");a.className="flex flex-col";let s=document.createElement("span");s.className="font-semibold text-gray-700",s.textContent=e.website;let i=document.createElement("span");i.className="text-gray-600 text-sm",i.textContent=e.username||"(no username)",a.appendChild(s),a.appendChild(i);let c=document.createElement("div");c.className="flex items-center gap-3";let r=document.createElement("span");r.className="bg-gray-200 text-sm px-2 py-1 rounded cursor-pointer",r.textContent="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022";let p=!1;r.addEventListener("click",()=>{p?r.textContent="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":r.textContent=e.password||"",p=!p});let u=document.createElement("button");u.className="text-xs bg-gray-300 px-2 py-1 rounded hover:bg-gray-400",u.textContent="Details",u.addEventListener("click",H=>{H.stopPropagation(),_(e)}),c.appendChild(r),c.appendChild(u),n.appendChild(a),n.appendChild(c),E.appendChild(n)})}function _(t){R.textContent=t.website,V.textContent=t.username,W.textContent=t.password,q.textContent=t.note,x.classList.remove("hidden")}function $(){x.classList.add("hidden")}function ee(t){let e=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download="passwords.json",a.click(),URL.revokeObjectURL(n)}w.addEventListener("change",async()=>{B?.classList.add("hidden"),S.classList.add("hidden");let t=w.files?.[0];if(t)try{let e=await t.text();JSON.parse(e),B?.classList.remove("hidden")}catch(e){console.warn("Invalid JSON format",e)}});A.addEventListener("click",async()=>{let t=w.files?.[0];if(!t){alert("No file selected");return}try{let e=await t.text(),n=prompt("Enter master password if any (or leave blank):")||"";y=n;let a=await Z(e,n),s=JSON.parse(e);s.iv&&s.salt?(l=new Uint8Array(m(s.salt)),d=new Uint8Array(m(s.iv))):(l=null,d=null),o=a,o.metadata||(o.metadata={algorithm:"AES-GCM",securityLevel:"256-bit"}),D.textContent=o.metadata.algorithm,N.textContent=o.metadata.securityLevel,S.classList.remove("hidden"),f(),alert("File loaded successfully")}catch(e){console.error(e),alert("Failed to load/decrypt file. Check console for details.")}});P.addEventListener("click",()=>{v.classList.remove("hidden")});k.addEventListener("click",()=>{v.classList.add("hidden")});O.addEventListener("click",()=>{y=M.value||"",o.metadata.algorithm=U.value,o.metadata.securityLevel=J.value,o.entries=[],l=null,d=null,f(),v.classList.add("hidden"),M.value="",alert("New storage created! Use 'Save & Download' to export.")});F.addEventListener("click",()=>{L.classList.remove("hidden")});j.addEventListener("click",()=>{L.classList.add("hidden")});K.addEventListener("click",()=>{let t={website:h.value.trim(),username:I.value.trim(),password:b.value.trim(),note:C.value.trim()};o.entries.push(t),h.value="",I.value="",b.value="",C.value="",L.classList.add("hidden"),f()});G.addEventListener("click",()=>{$()});z.addEventListener("click",async()=>{try{let t=await Y();ee(t)}catch(t){console.error(t),alert("Failed to save. Check console for details.")}});})();
