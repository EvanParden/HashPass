"use strict";(()=>{var g=document.getElementById("masterPassword"),L=document.getElementById("jsonFileInput"),M=document.getElementById("loadJsonBtn"),P=document.getElementById("createJsonBtn"),u=document.getElementById("entriesTableBody"),h=document.getElementById("addEntryForm"),y=document.getElementById("websiteInput"),p=document.getElementById("usernameInput"),E=document.getElementById("passwordInput"),w=document.getElementById("noteInput"),C=document.getElementById("downloadJsonBtn"),f=document.getElementById("entryModal"),S=document.getElementById("modalWebsite"),B=document.getElementById("modalUsername"),b=document.getElementById("modalPassword"),H=document.getElementById("modalNotes"),A=document.getElementById("closeModalBtn"),x=document.getElementById("copyUsernameBtn"),U=document.getElementById("copyPasswordBtn"),d=[],a=null,s=null;function l(e){let n=window.atob(e),t=n.length,r=new Uint8Array(t);for(let o=0;o<t;o++)r[o]=n.charCodeAt(o);return r.buffer}function i(e){let n=new Uint8Array(e),t="";for(let r=0;r<n.byteLength;r++)t+=String.fromCharCode(n[r]);return window.btoa(t)}async function v(e,n){let t=new TextEncoder,r=await window.crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function N(e,n){a||(a=window.crypto.getRandomValues(new Uint8Array(16))),s||(s=window.crypto.getRandomValues(new Uint8Array(12)));let t=await v(e,a),r=new TextEncoder,o=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},t,r.encode(n));return{iv:i(s.buffer),salt:i(a.buffer),data:i(o)}}async function k(e,n){let t=new Uint8Array(l(n.iv)),r=new Uint8Array(l(n.salt)),o=l(n.data),c=await v(e,r),I=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:t},c,o);return new TextDecoder().decode(I)}async function J(e,n){let t=JSON.stringify(n);if(!e)return JSON.stringify({iv:"",salt:"",data:t},null,2);let r=await N(e,t);return JSON.stringify(r,null,2)}async function F(e,n){let t=JSON.parse(n);if(!t.iv&&!t.salt)return JSON.parse(t.data);{let r=await k(e,t);return JSON.parse(r)}}function m(){u.innerHTML="",d.forEach((e,n)=>{let t=document.createElement("tr");t.className="cursor-pointer hover:bg-gray-50";let r=document.createElement("td");r.className="p-3",r.textContent=e.website;let o=document.createElement("td");o.className="p-3",o.textContent=e.username;let c=document.createElement("td");c.className="p-3",c.textContent="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",t.addEventListener("click",()=>{O(e)}),t.appendChild(r),t.appendChild(o),t.appendChild(c),u.appendChild(t)})}function O(e){S.textContent=e.website,B.textContent=e.username,b.textContent=e.password,H.textContent=e.note,f.classList.remove("hidden")}function D(){f.classList.add("hidden")}function T(e){navigator.clipboard.writeText(e).then(()=>{alert("Copied to clipboard")},n=>{console.error("Failed to copy: ",n),alert("Failed to copy to clipboard.")})}M.addEventListener("click",async()=>{let e=L.files?.[0],n=g.value;if(!e){alert("Please select a JSON file.");return}try{let t=await e.text(),r=await F(n,t),o=JSON.parse(t);o.iv&&o.salt?(a=new Uint8Array(l(o.salt)),s=new Uint8Array(l(o.iv))):(a=null,s=null),d=r,m(),alert("File loaded successfully!")}catch(t){console.error(t),alert("Failed to load or decrypt. Check console for details.")}});P.addEventListener("click",()=>{d=[],a=null,s=null,m(),alert("New storage created (currently empty).")});h.addEventListener("submit",e=>{e.preventDefault();let n={website:y.value.trim(),username:p.value.trim(),password:E.value.trim(),note:w.value.trim()};d.push(n),y.value="",p.value="",E.value="",w.value="",m()});C.addEventListener("click",async()=>{try{let e=g.value,n=await J(e,d),t=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(t),o=document.createElement("a");o.href=r,o.download="passwords.json",o.click(),URL.revokeObjectURL(r)}catch(e){console.error(e),alert("Save failed. Check console for details.")}});A.addEventListener("click",()=>{D()});x.addEventListener("click",e=>{e.stopPropagation(),T(B.textContent||"")});U.addEventListener("click",e=>{e.stopPropagation(),T(b.textContent||"")});})();
