"use strict";(()=>{var w=document.getElementById("jsonFileInput"),L=document.getElementById("validIcon"),H=document.getElementById("loadJsonBtn"),A=document.getElementById("openCreateModalBtn"),g=document.getElementById("createStorageModal"),N=document.getElementById("closeCreateModalBtn"),M=document.getElementById("createMasterPasswordInput"),P=document.getElementById("createStorageBtn"),p=document.getElementById("entriesContainer"),k=document.getElementById("openAddEntryBtn"),f=document.getElementById("addEntryModal"),U=document.getElementById("closeAddEntryModalBtn"),I=document.getElementById("websiteInput"),h=document.getElementById("usernameInput"),b=document.getElementById("passwordInput"),x=document.getElementById("noteInput"),D=document.getElementById("submitNewEntryBtn"),C=document.getElementById("detailModal"),J=document.getElementById("closeDetailModalBtn"),O=document.getElementById("detailWebsite"),j=document.getElementById("detailUsername"),F=document.getElementById("detailPassword"),K=document.getElementById("detailNotes"),R=document.getElementById("downloadJsonBtn"),c=[],B="",o=null,d=null;function m(e){let n=window.atob(e),t=n.length,a=new Uint8Array(t);for(let s=0;s<t;s++)a[s]=n.charCodeAt(s);return a.buffer}function E(e){let n=new Uint8Array(e),t="";for(let a=0;a<n.byteLength;a++)t+=String.fromCharCode(n[a]);return window.btoa(t)}async function S(e,n){let t=new TextEncoder,a=await window.crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function G(e,n){o||(o=window.crypto.getRandomValues(new Uint8Array(16))),d||(d=window.crypto.getRandomValues(new Uint8Array(12)));let t=await S(e,o),a=new TextEncoder,s=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:d},t,a.encode(n));return{iv:E(d.buffer),salt:E(o.buffer),data:E(s)}}async function V(e,n){let t=new Uint8Array(m(n.iv)),a=new Uint8Array(m(n.salt)),s=m(n.data),i=await S(e,a),l=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:t},i,s);return new TextDecoder().decode(l)}async function W(e,n){let t=JSON.stringify(n);if(!e)return JSON.stringify({iv:"",salt:"",data:t},null,2);let a=await G(e,t);return JSON.stringify(a,null,2)}async function q(e,n){let t=JSON.parse(n);if(!t.iv&&!t.salt)return JSON.parse(t.data);{let a=await V(e,t);return JSON.parse(a)}}function v(){if(p.innerHTML="",c.length===0){let e=document.createElement("div");e.className="text-gray-500 text-center p-4",e.textContent="No entries yet",p.appendChild(e);return}c.forEach((e,n)=>{let t=document.createElement("div");t.className="p-3 border rounded flex items-center justify-between hover:bg-gray-50";let a=document.createElement("div");a.className="flex flex-col";let s=document.createElement("span");s.className="font-semibold text-gray-700",s.textContent=e.website;let i=document.createElement("span");i.className="text-gray-600 text-sm",i.textContent=e.username||"(no username)",a.appendChild(s),a.appendChild(i);let l=document.createElement("div");l.className="flex items-center gap-3";let r=document.createElement("span");r.className="bg-gray-200 text-sm px-2 py-1 rounded cursor-pointer",r.textContent="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022";let y=!1;r.addEventListener("click",()=>{y?r.textContent="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":r.textContent=e.password||"",y=!y});let u=document.createElement("button");u.className="text-xs bg-gray-300 px-2 py-1 rounded hover:bg-gray-400",u.textContent="Details",u.addEventListener("click",T=>{T.stopPropagation(),z(e)}),l.appendChild(r),l.appendChild(u),t.appendChild(a),t.appendChild(l),p.appendChild(t)})}function z(e){O.textContent=e.website,j.textContent=e.username,F.textContent=e.password,K.textContent=e.note,C.classList.remove("hidden")}function Q(){C.classList.add("hidden")}w.addEventListener("change",async()=>{L?.classList.add("hidden");let e=w.files?.[0];if(e)try{let n=await e.text();JSON.parse(n),L?.classList.remove("hidden")}catch(n){console.warn("Invalid JSON format",n)}});H.addEventListener("click",async()=>{let e=w.files?.[0];if(!e){alert("No file selected");return}try{let n=await e.text(),t=prompt("Enter master password if any (or leave blank):")||"";B=t;let a=await q(t,n),s=JSON.parse(n);s.iv&&s.salt?(o=new Uint8Array(m(s.salt)),d=new Uint8Array(m(s.iv))):(o=null,d=null),c=a,v(),alert("File loaded successfully")}catch(n){console.error(n),alert("Failed to load/decrypt file. Check console for details.")}});A.addEventListener("click",()=>{g.classList.remove("hidden")});N.addEventListener("click",()=>{g.classList.add("hidden")});P.addEventListener("click",()=>{B=M.value||"",c=[],o=null,d=null,v(),g.classList.add("hidden"),M.value="",alert("New storage created!")});k.addEventListener("click",()=>{f.classList.remove("hidden")});U.addEventListener("click",()=>{f.classList.add("hidden")});D.addEventListener("click",()=>{let e={website:I.value.trim(),username:h.value.trim(),password:b.value.trim(),note:x.value.trim()};c.push(e),I.value="",h.value="",b.value="",x.value="",f.classList.add("hidden"),v()});J.addEventListener("click",()=>{Q()});R.addEventListener("click",async()=>{try{let e=await W(B,c),n=new Blob([e],{type:"application/json"}),t=URL.createObjectURL(n),a=document.createElement("a");a.href=t,a.download="passwords.json",a.click(),URL.revokeObjectURL(t)}catch(e){console.error(e),alert("Failed to save. Check console.")}});})();
